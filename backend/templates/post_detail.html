<!DOCTYPE html>
<html>
<head>
    <title>{{ post.title }} - 我的博客</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-glass: rgba(255, 255, 255, 0.05);
            --bg-glass-hover: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f23 100%);
            line-height: 1.6;
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow-wrap: break-word;
            transition: all 0.3s ease;
        }

        .container:hover {
            box-shadow: var(--shadow-hover);
        }
        h1 {
            color: var(--text-primary);
            text-align: left;
            margin-bottom: 2rem;
            word-break: break-word;
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .post-content {
            color: var(--text-primary);
            font-size: 1.1rem;
            line-height: 1.8;
        }
        .post-images {
            margin-bottom: 2rem;
            text-align: center;
        }
        .post-detail-image {
            max-width: 100%;
            height: auto;
            margin: 1rem 0;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .post-detail-image:hover {
            transform: scale(1.02);
        }

        .post-content p {
            margin-bottom: 1.5rem;
        }

        .post-content a {
            color: var(--accent);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .post-content a:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }
        .admin-actions {
            text-align: center;
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .edit-button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .edit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .admin-actions button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(225, 29, 72, 0.3);
        }
        .back-link {
            display: inline-block;
            margin-top: 2rem;
            color: var(--accent);
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .back-link:hover {
            color: var(--accent-hover);
            background: var(--bg-glass-hover);
            transform: translateY(-2px);
        }
        .post-content .parsed-link {
            color: var(--accent);
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .post-content .parsed-link:hover {
            color: var(--accent-hover);
        }

        /* 评论区样式 */
        .comments-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .comments-list {
            margin-bottom: 2rem;
        }

        .comment-item {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .comment-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .comment-user {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .comment-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .comment-content {
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .comment-actions {
            display: flex;
            gap: 0.5rem;
        }

        .edit-comment-btn, .delete-comment-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-comment-btn {
            background: rgba(59, 130, 246, 0.2);
            color: var(--text-primary);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .edit-comment-btn:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .delete-comment-btn {
            background: rgba(239, 68, 68, 0.2);
            color: var(--text-primary);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .delete-comment-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .comment-input-section {
            margin-top: 1rem;
        }

        .comment-input-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .comment-input {
            flex: 1;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .comment-send-btn {
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .comment-send-btn:hover {
            background: var(--accent-hover);
        }

        .comment-send-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        .comment-cooldown {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ post.title }}</h1>
        {# 显示所有图片 #}
        {% if post.image_urls %}
            <div class="post-images">
                {% for image_url in post.image_urls %}
                    <img src="{{ image_url }}" alt="文章图片" class="post-detail-image">
                {% endfor %}
            </div>
        {% endif %}
        <div class="post-content">
            {{ post.content | safe }}
        </div>

        <!-- 评论区 -->
        <div class="comments-section">
            <h3 style="color: var(--text-primary); margin: 2rem 0 1rem 0; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border);">
                评论 ({{ comments|length }})
            </h3>
            
            <div class="comments-list">
                {% for comment in comments %}
                <div class="comment-item">
                    <div class="comment-header">
                        <span class="comment-user">{{ comment.user }}</span>
                        <span class="comment-time">{{ comment.timestamp|timestamp_to_date }}</span>
                        {% if user == 'admin' %}
                        <div class="comment-actions">
                            <button class="edit-comment-btn" onclick="editComment({{ comment.id }}, '{{ comment.content|replace("'", "\\'") }}')">编辑</button>
                            <button class="delete-comment-btn" onclick="deleteComment({{ comment.id }})">删除</button>
                        </div>
                        {% endif %}
                    </div>
                    <div class="comment-content">{{ comment.content }}</div>
                </div>
                {% endfor %}
            </div>
            
            {% if user != '游客' %}
            <div class="comment-input-section">
                <div class="comment-input-container">
                    <input type="text" class="comment-input" id="commentInput" placeholder="发表评论..." maxlength="500">
                    <button class="comment-send-btn" onclick="sendComment('post', '{{ post_id }}')">发送</button>
                </div>
                <div class="comment-cooldown" id="cooldown" style="display: none;"></div>
            </div>
            {% endif %}
        </div>

        {% if user == 'admin' %}
        <div class="admin-actions">
            <a href="{{ url_for('edit_post', post_id=post_id) }}" class="edit-button">{{ text.edit_post }}</a>
            <button onclick="deletePost('{{ post_id }}')">{{ text.delete_post }}</button>
        </div>
        {% endif %}

        <a href="{{ url_for('index') }}" class="back-link">{{ text.back_home }}</a>
    </div>
    <script>
        const postId = '{{ post_id }}'; // 将post_id赋值给JavaScript变量
        const indexUrl = '{{ url_for("index") }}'; // 将index url赋值给JavaScript变量

        // 实现特殊符号框起来的链接解析
        document.addEventListener('DOMContentLoaded', function() {
            const postContent = document.querySelector('.post-content');
            let content = postContent.innerHTML;
            // 简单的链接解析，查找 [[链接文字|URL]] 格式
            const linkRegex = /\[\[(.*?)\|(.*?)\]\]/g;
            content = content.replace(linkRegex, '<a href="$2" target="_blank" class="parsed-link">$1</a>');
            postContent.innerHTML = content;
        });

        // 评论区功能
        function sendComment(type, targetId) {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            
            if (!content) {
                alert('请输入评论内容');
                return;
            }
            
            const sendBtn = input.nextElementSibling;
            const cooldownDiv = document.getElementById('cooldown');
            
            // 禁用发送按钮
            sendBtn.disabled = true;
            sendBtn.textContent = '发送中...';
            
            fetch('/api/comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: type,
                    target_id: parseInt(targetId),
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    // 显示冷却时间
                    showCooldown(3);
                    // 重新加载页面以显示新评论
                    location.reload();
                } else {
                    alert(data.message);
                    sendBtn.disabled = false;
                    sendBtn.textContent = '发送';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('发送失败');
                sendBtn.disabled = false;
                sendBtn.textContent = '发送';
            });
        }

        function showCooldown(seconds) {
            const cooldownDiv = document.getElementById('cooldown');
            const sendBtn = document.getElementById('commentInput').nextElementSibling;
            
            cooldownDiv.style.display = 'block';
            sendBtn.disabled = true;
            
            let remaining = seconds;
            const timer = setInterval(() => {
                cooldownDiv.textContent = `请等待 ${remaining} 秒后再发送`;
                remaining--;
                
                if (remaining < 0) {
                    clearInterval(timer);
                    cooldownDiv.style.display = 'none';
                    sendBtn.disabled = false;
                    sendBtn.textContent = '发送';
                }
            }, 1000);
        }

        // 编辑评论
        function editComment(commentId, currentContent) {
            const newContent = prompt('编辑评论:', currentContent);
            if (newContent && newContent !== currentContent) {
                fetch(`/api/comments/${commentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: newContent })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('编辑失败');
                });
            }
        }

        // 删除评论
        function deleteComment(commentId) {
            if (confirm('确定要删除这条评论吗？')) {
                fetch(`/api/comments/${commentId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败');
                });
            }
        }

        // 支持回车键发送评论
        document.addEventListener('DOMContentLoaded', function() {
            const commentInput = document.getElementById('commentInput');
            if (commentInput) {
                commentInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendComment('post', '{{ post_id }}');
                    }
                });
            }
        });

        // 管理员删除文章功能
        function deletePost(postId) {
            if (confirm('{{ text.confirm_delete_post }}')) {
                fetch('/admin/delete_post/' + postId, {
                    method: 'POST',
                })
                .then(response => {
                    if (response.ok) {
                        alert('{{ text.delete_success }}');
                        window.location.href = indexUrl;
                    } else {
                        alert('{{ text.delete_fail }}');
                    }
                })
                .catch(error => {
                    console.error('{{ text.delete_error }}:', error);
                    alert('{{ text.delete_error }}');
                });
            }
        }
    </script>
</body>
</html> 